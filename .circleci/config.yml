version: 2.1

jobs:
  build:
    docker:
      - image: circleci/php:7.4-apache-node-browsers
    working_directory: ~/repo
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            apt-get update && apt-get install -y \
              curl \
              git \
              libpng-dev \
              libjpeg-dev \
              libzip-dev \
              unzip \
              zip \
              php-xml \
              php-mbstring \
              php-intl \
              php-zip \
              php-gd \
              php-curl \
              php-mysql \
              mysql-client
            curl https://getcomposer.org/installer | php
            mv composer.phar /usr/local/bin/composer
      - run:
          name: Configure WordPress
          command: |
            cd ~/repo/wordpress
            brew mysql -e "CREATE DATABASE IF NOT EXISTS wordpress_test;" -uroot
            cp wp-tests-config-sample.php wp-tests-config.php
            sed -i 's/youremptytestdbnamehere/wordpress_test/' wp-tests-config.php
            sed -i 's/yourusernamehere/root/' wp-tests-config.php
            sed -i 's/yourpasswordhere//' wp-tests-config.php
            sed -i 's|localhost|127.0.0.1|' wp-tests-config.php
      - run:
          name: Install PHPUnit
          command: |
            cd ~/repo/wordpress
            wget -O phpunit https://phar.phpunit.de/phpunit-9.phar
            chmod +x phpunit
            sudo mv phpunit /usr/local/bin/phpunit
      - run:
          name: Run WordPress tests
          command: |
            cd ~/repo/wordpress
            phpunit --configuration phpunit.xml.dist
